# План развития tbot-controls-pc v1.1.1-final

**URL репозитория:** https://github.com/DiscipulusVitae/tbot-controls-pc
**Цель:** Реализация трех ключевых улучшений для повышения качества кода
**Приоритет:** Улучшение архитектуры и надежности

---

## **Этап 1: Рефакторинг управления медиа-клавишами (`refactor: Media Keys Abstraction`)**

### **Цель:** Улучшить читаемость кода и инкапсулировать логику работы с Windows API, устранив "магические числа" из `main.go`.

#### **1. Создание функции-обёртки:**
- [ ] В файле `winapi.go` создать новую публичную функцию `SendPlayPauseKey()`
- [ ] Внутри этой функции реализовать вызов уже существующей `SendMediaKey(VK_MEDIA_PLAY_PAUSE)`
- [ ] Добавить документацию к новой функции

#### **2. Интеграция в `main.go`:**
- [ ] В файле `main.go`, в блоке `switch` для обработки `callback_query`, найти `case "play_pause"`
- [ ] Заменить прямой вызов `SendMediaKey(0xB3)` на вызов новой функции `SendPlayPauseKey()`
- [ ] Обновить логирование, чтобы оно соответствовало вызову новой функции
- [ ] Убедиться, что код компилируется без ошибок

#### **3. Тестирование:**
- [ ] Проверить работоспособность кнопки Play/Pause
- [ ] Убедиться, что логирование корректно отображает новую функцию

**Ожидаемый результат:** Код стал более читаемым, магические числа инкапсулированы в отдельной функции

---

## **Этап 2: Рефакторинг отправки сообщений (`refactor: Message Sending Logic`)**

### **Цель:** Устранить дублирование кода и упростить логику отправки панели управления пользователю.

#### **1. Объединение функций:**
- [ ] В файле `main.go` удалить функцию `sendTextMessage`
- [ ] Модифицировать функцию `sendPanelToUser`
- [ ] Внутри `sendPanelToUser` оставить основную логику отправки фото
- [ ] В блоке обработки ошибок (`if err != nil`), где ранее вызывалась `sendTextMessage`, теперь напрямую реализовать отправку текстового сообщения `tgbotapi.NewMessage` в качестве запасного варианта
- [ ] Обновить все связанные сообщения в логах, чтобы отразить единую логику

#### **2. Рефакторинг логирования:**
- [ ] Обновить сообщения логов для отражения единой логики отправки
- [ ] Убедиться, что логи корректно отображают процесс отправки как фото, так и текстовых сообщений

#### **3. Тестирование:**
- [ ] Проверить отправку панели с изображением
- [ ] Проверить отправку панели без изображения (текстовый fallback)
- [ ] Убедиться, что логирование корректно отражает процесс

**Ожидаемый результат:** Устранено дублирование кода, упрощена логика отправки сообщений

---

## **Этап 3: Внедрение Graceful Shutdown (`feat: Graceful Shutdown`)**

### **Цель:** Обеспечить корректное и плавное завершение работы бота при получении сигнала от операционной системы (например, при нажатии `Ctrl+C`), чтобы избежать обрыва соединений и потери логов.

#### **1. Импорт пакетов:**
- [ ] В `main.go` добавить импорт пакетов `"os/signal"` и `"context"`

#### **2. Создание контекста с отменой:**
- [ ] В начале функции `main` создать родительский контекст `context.Background()`
- [ ] Использовать `signal.NotifyContext` для создания дочернего контекста, который будет автоматически отменён при получении сигналов `syscall.SIGINT` или `syscall.SIGTERM`

#### **3. Остановка цикла обновлений:**
- [ ] Создать отдельную горутину, которая будет запускать цикл `for update := range updates`
- [ ] В основной горутине (в `main`) дождаться отмены контекста с помощью `<-ctx.Done()`

#### **4. Корректное завершение:**
- [ ] После получения сигнала об отмене контекста, остановить получение новых обновлений с помощью `bot.StopReceivingUpdates()`
- [ ] Добавить в лог сообщение о штатном завершении работы (`"Бот останавливается по сигналу..."`)
- [ ] Добавить финальное логирование статистики работы

#### **5. Тестирование:**
- [ ] Протестировать завершение работы через `Ctrl+C`
- [ ] Проверить корректность логирования при завершении
- [ ] Убедиться, что соединение с Telegram API корректно закрывается

**Ожидаемый результат:** Бот корректно завершается по сигналам ОС, логи сохраняются, соединения закрываются gracefully

---

## **Технические требования**

### **Общие требования:**
- **Go версии:** 1.21+
- **Совместимость:** Windows 11 x64
- **Архитектура:** Сохранение существующей структуры проекта
- **Тестирование:** Ручное тестирование каждой функции
- **Документация:** Обновление `docs/project-state-1.1.1.md` после каждого этапа

### **Стандарты кода:**
- **Форматирование:** `go fmt`
- **Линтинг:** Проверка на отсутствие ошибок компиляции
- **Комментарии:** Добавление комментариев к новым функциям
- **Обработка ошибок:** Сохранение существующей логики обработки ошибок

---

## **Порядок реализации**

Рекомендуемый порядок выполнения этапов:

1. **Этап 1:** Рефакторинг медиа-клавиш (самый простой, улучшает читаемость)
2. **Этап 2:** Рефакторинг отправки сообщений (устраняет дублирование)
3. **Этап 3:** Graceful Shutdown (повышает надежность работы)

---

## **Оценка сложности и времени**

### **Этап 1 (Рефакторинг медиа-клавиш):**
- **Сложность:** Низкая
- **Время:** 15-30 минут
- **Риски:** Минимальные

### **Этап 2 (Рефакторинг отправки сообщений):**
- **Сложность:** Средняя
- **Время:** 30-45 минут
- **Риски:** Необходимо тщательно протестировать логику отправки

### **Этап 3 (Graceful Shutdown):**
- **Сложность:** Средняя
- **Время:** 45-60 минут
- **Риски:** Требуется тестирование различных сценариев завершения

---

**Версия плана:** 1.1.1-final
**Дата создания:** 27 августа 2025 г.
**Статус:** Активный
**Приоритет реализации:** Высокий
